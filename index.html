<html>
  <head>
    <script src="https://vk.com/js/api/xd_connection.js?2" type="text/javascript"></script>
    <script src="request.js"></script>
    <script type="text/javascript">
      var parts = window.location.href.split('&hash=');
      var params = parts[parts.length - 1];
      var access_token = location.href.split('access_token=')[1].split('&')[0];
      var host = 'http://localhost';
      var serverDest = host + '?access_token=' + access_token + '&text_id=' + params;
      VK.init(function() { 
        VK.addCallback('onSettingsChanged', function() {
          request({
            url: serverDest,
            json: true
          }, function (err, res, body) {
            if(body.photo) {
              VK.api('wall.post', {
                message: '#модульгод',
                attachments: body.photo,
                v: '5.73'
              }, function (data) {
                if(data.response) {
                  document.querySelector('#message').innerHTML = 'Поздравляем. Теперь вы участвуете в конкурсе!'
                }
              });
            }
          })
        });
        VK.callMethod('showSettingsBox', 8196);
      }, function() {}, '5.92'); 
    </script>
  </head>
  <body>
    <h1 id="message"></h1>
  </body>
</html>